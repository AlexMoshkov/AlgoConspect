---
cards-deck: Алгоритмы и структуры данных
---
### Полиномиальный хеш

#### Полиномиальный хеш #card 
Символы `char` принимают значение $\{0, 1, \dots, \sigma - 1\}$ (часто $\sigma = 2^8$ или $2^{16}$)
Зафиксируем простое $p$ типа `uint`, такое что $p\ge \sigma$
В начале работы программы выберем случайное число $x \in \{1, 2, \dots, p - 1\}$
**Полиномиальный хеш (хеш Карпа-Рабина** для строки $s$ длины $n$:
$$\Large h(s) = \sum\limits^{n - 1}_{k = 0} s[k] \cdot x^{n-k-1} \mod p = (s[0] \cdot x^{n-1} + s[1]\cdot x^{n-2} + \dots + s[n-1]) \mod p$$
$$\Large h: Строки \to \{0, 1, \dots, p-1\}$$
###### Всякие свойства:
- Чем больше простое $p$, тем больше область значений $\{0, 1, \dots, p - 1\}$ и тем меньше коллизий
- Для 32-битового хеша $p=2^{32}-5$ (наибольшее), $p=2^{31} - 1$ (удобное)
  Для 64-битового хеша $p=2^{64}-59$ (наибольшее), $p=2^{61} - 1$ (удобное)
- Если $|s| = 1$, то $h(s) = s[0]$, т.к. $p \ge \sigma$
- Вычисляется по схеме Горнера (за $O(n)$ времени):
   $$\Large h(s) = (\dots ((s[0]x + s[1])x + \dots + s[n - 2])x + s[n-1]$$
   *Пример*: $\large s[0]\cdot x^3 + s[1] \cdot x^2 + s[2] \cdot x + s[3] = ((s[0]x + s[1])x + s[2])x + s[3]$
^1654862366261

#### Вероятность коллизии в хеш функции #card
**Теорема**
Для различных строк $s$ и $t$, таких что либо $|s| = |t|$, либо $s[0] \neq 0$ и $t[0] \neq 0$, выполняется $\Large P(h(s)=h(t)) \le \frac{\max\{|s|, |t|\}-1}{p-1}$ при случайном выборе $x \in \{1, 2, \dots, p-1\}$
**Доказательство**
Обозначим длины $s$ и $t$ через $n=|s|$ и $m=|t|$ соответственно
Пусть $f(x) = \sum\limits^{n-1}_{k=0} s[k] \cdot x^{n-k-1}$ и $g(x)=\sum\limits^{m-1}_{k=0}t[k] \cdot x^{m-k-1}$ два различных многочлена кольца $\mathbb Z_p$  
\
Так как все коофициенты $s[k]$ и $t[k]$ принадлежат $\mathbb Z_p$ (из-за условия $\sigma \le p$) и $s[0] \neq 0, t[0] \neq 0$ при $n \neq m$, то:
$h(s) = h(t) \iff$ многочлены $f$ и $g$ при данном $x$ принимают одно и тоже значение в $\mathbb Z_p$ $\implies$
$h(s) = h(t) \iff$ $x$ является корнем $d(x) = f(x) - g(x)$ в $\mathbb Z_p$
\
Так как $f \not\equiv g$, то $d(x) \not\equiv 0$ и $\deg d \le \max\{\deg f, \deg g\} \le \max\{n-1, m-1\}$
Поскольку $\mathbb Z_p$ - поле, то $d(x)$ имеет не более $\deg d$ корней (по теореме из алгебры)
Значит, случайный $x \in \{1, 2,\dots, p-1\}$ является корнем $d(x)$ с вероятностью $\large \le \frac{\deg d}{p - 1} \le \frac{\max\{n-1, m-1\}}{p - 1} = \frac{\max\{|s|, |t|\}-1}{p-1}$
\
*Следствия и замечания*
При $|s| \neq |t|$, условие $s[0]\neq 0, t[0] \neq 0$ важно
Пример: `s="01"` и `t="1"` имеют одинаковый хеш $h(s)=h(t)=1$ при любом $x\in\{1, 2,\dots, p-1\}$
Поэтому при реализации полиномиального хеша будем полагать что у строк есть скрытый символ `s[-1]="1"` (начинаем вычисление хеша не с 0 а с 1 в самой реализации)
^1654847842777

#### Число коллизий в хеш таблице #card
**Теорема**
Для любой строки $s$ и различных строк $s_1, s_2, \dots, s_m$ таких что $|s|\le l$ и $|s_k| \le l$ для $k\in\{1,\dots, m\}$, мат ожидание числа коллизий $h(s)=h(s_k)$ меньше $\large \frac{m\cdot l}{p-1}$ (при случайно $x \in \{1, \dots, p-1\}$)
**Доказательство**
Введем индикаторную случайную величину $I_k=\begin{cases}0, & если\ h(s)\neq h(s_k) \\ 1, & если\ h(s)=h(s_k)\end{cases}$
\
Так как $E[I_k] = P(h(s) = h(s_k))$, то $E[I_k] < \frac{l}{p-1}$ по [[#^03d496|теореме о вероятности коллизий]]
\
Поэтому $E[\sum I_k] = \sum E[I_k] < \frac{m\cdot l}{p-1}$
^1654848489701

#### Операции над хешами #card
**Теорема**
Для любых строк $s$, $t$ можно за $O(1)$ получить:
1. по хешам $h(s)$ и $h(t)$ хеш $h(st)$, если известно $x^{|t|} \mod p$
2. по хешам $h(s)$ и $h(st)$ хеш $h(t)$, если известно $x^{|t|} \mod p$
3. по хешам $h(t)$ и $h(st)$ хеш $h(s)$, если известно $x^{-|t|} \mod p$
\
**Доказательство**
- $\big( h(s) \cdot x^{|t|} + h(t)\big) \mod p = h(st)$
- $\big( h(st) - h(s) \cdot x^{|t|} \big) \mod p = h(t)$
- $\big( (h(st) - h(t)) \cdot x^{-|t|}\big) \mod p = h(s)$
^1654853620492
